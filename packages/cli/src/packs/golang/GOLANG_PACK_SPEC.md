# Go Language Pack Specification

Implementation spec for adding Go support to safeword.

## Go Tooling Overview

| Tool | Purpose | Config |
|------|---------|--------|
| **golangci-lint** | Meta-linter (50+ linters) + formatter | `.golangci.yml` |
| **depguard** | Architecture/import rules | Inside `.golangci.yml` |

**Key insight:** Go is simpler than Python:
- Single tool: `golangci-lint` handles both linting and formatting (via gofumpt)
- Single package manager (`go mod`)
- Single config file (`.golangci.yml`)

---

## Integration Points

### 1. Pack File (`src/packs/golang/index.ts`)

```typescript
import nodePath from 'node:path';
import { exists } from '../../utils/fs.js';
import type { LanguagePack, SetupResult } from '../types.js';
import { setupGoTooling } from './setup.js';

export const golangPack: LanguagePack = {
  id: 'golang',
  name: 'Go',
  extensions: ['.go'],

  detect(cwd: string): boolean {
    return exists(nodePath.join(cwd, 'go.mod'));
  },

  setup(cwd: string): SetupResult {
    return setupGoTooling(cwd);
  },
};
```

### 2. Registry (`src/packs/registry.ts`)

```typescript
import { golangPack } from './golang/index.js';

export const LANGUAGE_PACKS: Record<string, LanguagePack> = {
  // ...existing
  golang: golangPack,
};
```

### 3. Lint Hook (`templates/hooks/lib/lint.ts`)

```typescript
const GO_EXTENSIONS = new Set(['go']);

// In lintFile():
if (GO_EXTENSIONS.has(extension)) {
  // golangci-lint v2: run --fix for linting, fmt for formatting
  await $`golangci-lint run --fix ${file}`.nothrow().quiet();
  await $`golangci-lint fmt ${file}`.nothrow().quiet();
  return;
}
```

**Note:** `golangci-lint fmt` applies gofumpt (if configured). Falls back gracefully if not installed.

### 4. Setup File (`src/packs/golang/setup.ts`)

```typescript
export function setupGoTooling(cwd: string): SetupResult {
  const result: SetupResult = { files: [] };

  const configPath = nodePath.join(cwd, '.golangci.yml');

  // Skip if config already exists
  if (exists(configPath)) {
    return result;
  }

  // Generate golangci-lint config
  const config = generateGolangciConfig(cwd);
  writeFile(configPath, config);
  result.files.push('.golangci.yml');

  return result;
}
```

---

## Config Generation

### `.golangci.yml` Template

```yaml
# Generated by safeword
version: "2"

linters:
  default: standard
  enable:
    - gocritic       # Opinionated checks
    - gosec          # Security scanner
    - misspell       # Spelling mistakes
    - unconvert      # Unnecessary type conversions
    - unparam        # Unused function parameters
  settings:
    gocritic:
      enabled-tags:
        - diagnostic
        - style
        - performance

formatters:
  enable:
    - gofumpt        # Stricter gofmt
```

**Note:** If 2+ architecture layers detected, `depguard` linter is added with import rules (see Architecture Detection).

### Architecture Detection

Detect Go layer directories (same patterns as Python):

```typescript
const GO_LAYERS: Record<string, string[]> = {
  domain: ['domain', 'models', 'entities', 'core'],
  services: ['services', 'usecases', 'application'],
  infra: ['infra', 'infrastructure', 'adapters', 'repositories'],
  api: ['api', 'handlers', 'routes', 'controllers'],
};

export function detectGoLayers(cwd: string): string[] {
  // Check internal/, pkg/, or root for layer patterns
  const searchPaths = ['internal', 'pkg', '.'];
  // Return detected layers in dependency order
}
```

If 2+ layers detected, add `depguard` rules to enforce boundaries.

---

## Test Helpers (`tests/helpers.ts`)

```typescript
/** Check if golangci-lint is installed */
export function isGolangciLintInstalled(): boolean {
  return isCommandAvailable('golangci-lint');
}

/** Create a Go project with go.mod */
export function createGoProject(dir: string, options?: { module?: string }): void {
  const module = options?.module ?? 'example.com/test-project';
  writeTestFile(dir, 'go.mod', `module ${module}

go 1.22
`);
  writeTestFile(dir, 'main.go', `package main

func main() {
	println("hello")
}
`);
}
```

---

## Test Plan

### Golden Path Test (`tests/integration/golang-golden-path.test.ts`)

```typescript
const GOLANGCI_LINT_AVAILABLE = isGolangciLintInstalled();

describe('E2E: Go Golden Path', () => {
  let projectDirectory: string;

  beforeAll(async () => {
    projectDirectory = createTemporaryDirectory();
    createGoProject(projectDirectory);
    initGitRepo(projectDirectory);
    await runCli(['setup', '--yes'], { cwd: projectDirectory, timeout: TIMEOUT_SETUP });
  }, 180_000);

  afterAll(() => {
    if (projectDirectory) removeTemporaryDirectory(projectDirectory);
  });

  it('creates golangci-lint config', () => {
    expect(fileExists(projectDirectory, '.golangci.yml')).toBe(true);
  });

  it.skipIf(!GOLANGCI_LINT_AVAILABLE)('golangci-lint config is valid', () => {
    const result = spawnSync('golangci-lint', ['config', 'verify'], { cwd: projectDirectory });
    expect(result.status).toBe(0);
  });

  it.skipIf(!GOLANGCI_LINT_AVAILABLE)('golangci-lint detects violations', () => {
    writeTestFile(projectDirectory, 'bad.go', `package main
func unused() {} // deadcode
`);
    const result = spawnSync('golangci-lint', ['run', 'bad.go'], { cwd: projectDirectory });
    expect(result.status).not.toBe(0);
  });

  it.skipIf(!GOLANGCI_LINT_AVAILABLE)('golangci-lint fmt formats files', () => {
    writeTestFile(projectDirectory, 'fmt.go', `package main
func main(){println("no spaces")}`);
    spawnSync('golangci-lint', ['fmt', 'fmt.go'], { cwd: projectDirectory });
    const content = readTestFile(projectDirectory, 'fmt.go');
    expect(content).toContain('func main() {');
  });

  it.skipIf(!GOLANGCI_LINT_AVAILABLE)('lint hook processes .go files', () => {...});
});
```

### Conditional Setup Tests (`tests/commands/setup-golang.test.ts`)

```typescript
describe('Conditional Setup for Go Projects', () => {
  it('skips JS tooling for Go-only projects', async () => {
    const dir = createTemporaryDirectory();
    createGoProject(dir);
    initGitRepo(dir);
    await runCli(['setup', '--yes'], { cwd: dir });

    expect(fileExists(dir, 'package.json')).toBe(false);
    expect(fileExists(dir, 'eslint.config.mjs')).toBe(false);
    expect(fileExists(dir, '.golangci.yml')).toBe(true);
  });

  it('does NOT create package.json for pure Go', () => {...});

  it('shows Go-appropriate next steps', () => {
    // Output should mention: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
  });

  it('still creates .safeword directory', () => {...});

  it('installs both toolchains for polyglot projects', () => {...});
});
```

### Mixed Project Tests

Update `tests/integration/mixed-project.test.ts`:

```typescript
describe('E2E: Mixed Project (TypeScript + Go)', () => {
  beforeAll(async () => {
    // Create project with both package.json and go.mod
  });

  it('detects both language packs', () => {...});
  it('creates eslint.config.mjs AND .golangci.yml', () => {...});
  it.skipIf(!GOLANGCI_LINT_AVAILABLE)('lint hook routes .go to golangci-lint', () => {...});
  it('lint hook routes .ts to ESLint', () => {...});
});
```

### Add Language Test

Update `tests/integration/add-language.test.ts`:

```typescript
describe('E2E: Add Go to Existing TypeScript Project', () => {
  it('starts with only TypeScript pack installed', () => {...});

  describe('after adding go.mod and running upgrade', () => {
    it('installs golang pack', () => {...});
    it('creates .golangci.yml', () => {...});
    it.skipIf(!GOLANGCI_LINT_AVAILABLE)('golangci-lint works on .go files', () => {...});
    it('ESLint still works on TypeScript files', () => {...});
  });
});
```

---

## Package Manager Detection

**Not needed for Go.** Go has a single package manager (`go mod`). No detection logic required.

---

## Install Guidance

Since Go tools are installed globally, show install command in output:

```
Next steps for Go:
  go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
```

Note: golangci-lint v2 includes gofumpt as a built-in formatter.

---

## Parity Checklist

Before shipping the Go language pack:

**Core Integration:**
- [ ] `detect()` returns true when `go.mod` exists
- [ ] `setup()` creates `.golangci.yml`
- [ ] Hook routes `.go` files to golangci-lint (lint + format)
- [ ] Hook skips gracefully if tools not installed

**Testing (6 test areas):**
- [ ] Golden path: config created, valid, detects violations, formats
- [ ] Tooling validation: N/A (Go is statically typed by compiler)
- [ ] Unit tests: layer detection, config generation
- [ ] Conditional setup: pure Go skips JS tooling
- [ ] Mixed project: Go + TypeScript work together
- [ ] Add language: can add Go to existing project

**Test Helpers:**
- [ ] `isGolangciLintInstalled()`
- [ ] `createGoProject(dir, options?)`

**Project Types:**
- [ ] Pure Go project (no package.json) works end-to-end
- [ ] Mixed project (JS + Go) works correctly
- [ ] Existing `.golangci.yml` is preserved (not clobbered)

---

## Implementation Order

1. **Phase 1: Core** (MVP)
   - Pack file (`golang/index.ts`)
   - Setup file (`golang/setup.ts`) with basic `.golangci.yml`
   - Registry registration
   - Lint hook extension

2. **Phase 2: Tests**
   - Test helpers
   - Golden path test
   - Conditional setup test

3. **Phase 3: Architecture**
   - Layer detection
   - depguard rules generation

4. **Phase 4: Integration**
   - Update mixed-project tests
   - Update add-language tests

---

## References

- [golangci-lint documentation](https://golangci-lint.run/docs/welcome/quick-start/)
- [golangci-lint v2 migration](https://ldez.github.io/blog/2025/03/23/golangci-lint-v2/)
- [gofumpt](https://github.com/mvdan/gofumpt)
- [Go linting best practices](https://www.glukhov.org/post/2025/11/linters-for-go/)
