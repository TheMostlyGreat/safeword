# Claude Code Quality Review Hook Setup

Automatically trigger quality review when Claude Code proposes or makes changes.

**Updated for 2025:** Self-contained setup script with project-local hooks, version tracking, and jq-based settings merging.

## Requirements

- **jq** - JSON processor required for Stop hooks
  - macOS: `brew install jq`
  - Ubuntu/Debian: `sudo apt-get install jq`
  - Other: https://jqlang.github.io/jq/download/
- **Claude Code with hooks support** - Stop hooks
- **AGENTS.md or CLAUDE.md** - Required in your project (or parent directory for monorepos)

## Quick Start

The setup script is fully self-contained - all hooks are generated inline, no global dependencies.

```bash
# Clone the agents repo (one-time setup)
git clone <YOUR_PRIVATE_REPO> /tmp/agents

# Run setup from your project directory
cd /path/to/your/project

# Run the setup script
bash /tmp/agents/coding/setup-quality-review.sh

# Cleanup (optional - script is standalone)
rm -rf /tmp/agents
```

**What gets created:**
- `.safeword/AGENTS.md` - Global patterns (copied from .safeword/)
- `.safeword/guides/` - Reference documentation (copied)
- `AGENTS.md` - Project-specific context template (if doesn't exist, references @./.safeword/AGENTS.md)
- `.claude/hooks/auto-quality-review.sh` - Stop hook with version comments
- `.claude/hooks/run-quality-review.sh` - Quality review prompt with version comments
- `.claude/commands/quality-review.md` - `/quality-review` slash command
- `.claude/settings.json` - Stop hook configuration (appends to existing)

**Idempotent:** Safe to run multiple times - won't duplicate hooks if already installed.

**Preserves:** Your `.agents/planning/` and `.agents/tickets/` folders are not touched.

**Standalone:** After running setup, project has no dependency on ~/.agents - all files are local.

**Commit:** Add `.agents/` and `.claude/` to git for team consistency.

## What It Does

The setup script configures your project to automatically trigger quality review when Claude proposes or makes changes.

**Created files:**
- `.claude/hooks/auto-quality-review.sh` - Stop hook that analyzes transcript for changes
- `.claude/hooks/run-quality-review.sh` - Shared quality review script
- `.claude/commands/quality-review.md` - Manual `/quality-review` command
- `.claude/settings.json` - Hook configuration (appends to existing, preserves other hooks)

**Version tracking:**
All generated files include version comments:
```bash
# Generated by .safeword/setup-quality-review.sh v1.0.0
# To upgrade: Re-run this script from your .agents repo
```

**Debug logging:**
The hook writes debug output to `/tmp/auto-quality-review-debug.log`:
```bash
tail -f /tmp/auto-quality-review-debug.log
```
This is useful for troubleshooting if the hook isn't triggering as expected.

## How It Works

### Stop Hook Architecture

The quality review system uses Claude Code's Stop hook to detect when changes are proposed or made:

1. **Stop hook triggers** on every Claude response
2. **auto-quality-review.sh analyzes transcript** for JSON blob: `{"proposedChanges": bool, "madeChanges": bool, "askedQuestion": bool}`
3. **If changes detected and no question asked** → Block and show quality review prompt
4. **Claude sees prompt** and performs self-review before continuing

### Hook Configuration

**`.claude/settings.json`:**
```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/auto-quality-review.sh"
          }
        ]
      }
    ]
  }
}
```

**`.claude/hooks/auto-quality-review.sh`** (Stop hook):
```bash
#!/bin/bash
# Generated by https://github.com/USER/agents v1.0.0

# Read hook input from stdin
input=$(cat)

# Extract transcript path
transcript_path=$(echo "$input" | jq -r '.transcript_path // empty')

# Check for AGENTS.md or CLAUDE.md (searches upward for monorepos)
# ... validation logic ...

# Extract last assistant message from transcript
last_assistant_msg=$(grep '"role":"assistant"' "$transcript_path" | tail -1)

# Extract JSON blob: {"proposedChanges": bool, "madeChanges": bool, "askedQuestion": bool}
json_blob=$(echo "$msg_text" | grep -oE '\{"proposedChanges":\s*(true|false)\s*,\s*"madeChanges":\s*(true|false)\s*,\s*"askedQuestion":\s*(true|false)\s*\}')

# Parse values
proposed_changes=$(echo "$json_blob" | jq -r '.proposedChanges // false')
made_changes=$(echo "$json_blob" | jq -r '.madeChanges // false')
asked_question=$(echo "$json_blob" | jq -r '.askedQuestion // false')

# Skip if Claude asked a question (waiting for user response)
if [ "$asked_question" = "true" ]; then
  exit 0
fi

# If changes proposed or made, trigger quality review
if [ "$proposed_changes" = "true" ] || [ "$made_changes" = "true" ]; then
  exec "$SCRIPT_DIR/run-quality-review.sh"
fi

exit 0
```

**`.claude/hooks/run-quality-review.sh`** (quality review prompt):
```bash
#!/bin/bash
# Generated by https://github.com/USER/agents v1.0.0

# Output quality review prompt to stderr (so Claude sees it)
echo "Double check and critique your work just in case." >&2
echo "" >&2
echo "- Is it correct?" >&2
echo "- Is it elegant?" >&2
echo "- Does it adhere to the latest documentation and best practices?" >&2
echo "- Ask me any non-obvious questions you can't research yourself." >&2
echo "- Think hard." >&2
echo "- Avoid bloat." >&2

# Exit with code 2 to block (Stop hook behavior)
exit 2
```

**Key features:**
- ✅ **Project-aware** - Only runs in projects with AGENTS.md or CLAUDE.md
- ✅ **Monorepo support** - Searches upward for context files
- ✅ **Question detection** - Skips review if Claude asked a question
- ✅ **Transcript analysis** - Detects changes via JSON blob parsing
- ✅ **Configurable** - Can disable per-project with `.auto-quality-review.config`
- ✅ **Manual trigger** - Use `/quality-review` command anytime
- ✅ **Non-intrusive** - Only triggers when changes are actually made

## Quality Review Prompt

When triggered, Claude is prompted to:

1. **Verify correctness** - Is the code/plan actually correct?
2. **Check elegance** - Is it clean, maintainable, well-designed?
3. **Validate best practices** - Does it follow latest documentation and patterns?
4. **Ask clarifying questions** - Any non-obvious questions that need user input?
5. **Think deeply** - Take time to consider edge cases and alternatives
6. **Avoid bloat** - Don't over-engineer or add unnecessary complexity

## Configuration

### Disabling for a Project

Create `.auto-quality-review.config` in your project root:

```bash
# Disable quality review for this project
enabled=false
```

Or disable questions only:

```bash
# Enable review but don't prompt to ask questions
enabled=true
ask_questions=false
```

### Customizing the Prompt

Edit `.claude/hooks/run-quality-review.sh` to customize the quality review prompt:

```bash
echo "Custom review prompt:" >&2
echo "- Check for security vulnerabilities" >&2
echo "- Verify test coverage" >&2
echo "- Review performance implications" >&2
```

### Combining with Linting

Quality review works great alongside linting hooks:

```bash
# Set up both systems
bash /tmp/agents/coding/setup-linting.sh --typescript
bash /tmp/agents/coding/setup-quality-review.sh
```

This creates a comprehensive review system:
- **Linting** (PostToolUse hook) - Immediate feedback on code style/errors
- **Quality review** (Stop hook) - Deeper review of correctness and design

Both hooks are merged into `.claude/settings.json`:
```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit|MultiEdit|NotebookEdit",
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/auto-lint.sh",
            "timeout": 15
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/auto-quality-review.sh"
          }
        ]
      }
    ]
  }
}
```

## Testing

After setup, test the hook:

1. Create `AGENTS.md` in your project (if not present):
   ```markdown
   # My Project

   This project uses Claude Code with quality review.
   ```

2. Start a new Claude Code session in your project

3. Ask Claude to create a file:
   ```
   Create a file test.js with a simple function
   ```

4. Watch for the quality review prompt after Claude proposes the change

5. Claude should perform a self-review before finalizing

## Troubleshooting

### Hook not triggering

**Check if AGENTS.md or CLAUDE.md exists:**
```bash
ls AGENTS.md CLAUDE.md
```

**Check hook registration:**
```bash
cat .claude/settings.json | jq '.hooks.Stop'
```

**Enable debug output:**
```bash
tail -f /tmp/auto-quality-review-debug.log
```

### JSON blob not found

The hook looks for this exact pattern in Claude's responses:
```json
{"proposedChanges": true, "madeChanges": false, "askedQuestion": false}
```

If Claude doesn't include this, the hook won't trigger. This is expected behavior - Claude should add this JSON blob when making changes.

### Hook triggering too often

Create `.auto-quality-review.config` to disable:
```bash
echo "enabled=false" > .auto-quality-review.config
```

Or just for specific sessions, use `.claude/settings.local.json`:
```json
{
  "hooks": {
    "Stop": []
  }
}
```

## Manual Quality Review

You can trigger quality review manually anytime using the `/quality-review` slash command:

```
/quality-review
```

This runs the same prompt without waiting for changes to be detected.

## Advanced: Monorepo Configuration

For monorepos, the hook searches upward for AGENTS.md or CLAUDE.md:

```
monorepo/
├── AGENTS.md          # Found by all packages
├── packages/
│   ├── app1/
│   │   └── .claude/   # Inherits from ../.. AGENTS.md
│   └── app2/
│       ├── AGENTS.md  # Uses its own (closer match)
│       └── .claude/
```

Each package can have its own `.auto-quality-review.config` to customize behavior:

```bash
# packages/app1/.auto-quality-review.config
enabled=true
ask_questions=true

# packages/app2/.auto-quality-review.config
enabled=false  # Disable for this package only
```

## What's New in v1.0.0

This setup script uses the latest best practices:

- **Self-contained** - All code generated inline via heredocs
- **Version tracking** - Generated files include version comments
- **jq merging** - Settings.json merged safely (preserves existing hooks)
- **Project-local** - No global dependencies or ~/.agents folder
- **Monorepo support** - Searches upward for AGENTS.md or CLAUDE.md
- **Question detection** - Skips review when Claude asks questions
- **Manual command** - `/quality-review` slash command included

## Resources

- [Claude Code Hooks Guide](https://code.claude.com/docs/en/hooks-guide.md)
- [Claude Code Stop Hooks](https://code.claude.com/docs/en/stop-hooks.md)
- [jq Manual](https://jqlang.github.io/jq/manual/)
