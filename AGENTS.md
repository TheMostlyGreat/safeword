**⚠️ ALWAYS READ FIRST: @./.safeword/SAFEWORD.md**

The SAFEWORD.md file contains core development patterns, workflows, and conventions.
Read it BEFORE working on any task in this project.

---

# SAFEWORD - AI Agent Configuration CLI

A CLI tool that sets up AI coding agent configurations (guides, hooks, templates) for any project.

## Project Purpose

**What:** `npx safeword setup` installs a `.safeword/` directory with guides, templates, and hooks into user projects.

**This repo is safeword's source code AND uses safeword itself (dogfooding).**

## Directory Roles

| Directory                       | Role                                                                                      |
| ------------------------------- | ----------------------------------------------------------------------------------------- |
| `packages/cli/`                 | **CLI source** - The `npx safeword` tool itself                                           |
| `packages/cli/templates/`       | **Source templates** - What the CLI copies to user projects                               |
| `packages/cli/src/schema.ts`    | **Single source of truth** - All managed files/dirs defined here                          |
| `packages/cli/src/reconcile.ts` | **Reconciliation engine** - Computes install/upgrade/uninstall plans                      |
| `.safeword/`                    | **Dogfooding** - This project's own installed safeword config (tracked, generated by CLI) |
| `.claude/`                      | **Claude Code config** - Settings, commands, skills for this project                      |
| `.cursor/`                      | **Cursor IDE config** - Rules and hooks synced from `.safeword/skills/`                   |

## Tech Stack

| Component | Technology                    |
| --------- | ----------------------------- |
| Runtime   | Bun (dev), Node 18+ (users)   |
| CLI       | TypeScript, Commander.js      |
| Build     | tsup (ESM-only output)        |
| Tests     | Vitest, promptfoo (LLM evals) |
| Linting   | ESLint 9 + Prettier           |

**Linting for Agents:** Warnings are useless to coding agents. Only auto-fixable rules and errors matter. Warnings require human judgment and should be reviewed outside the agent's loop.

## Testing

| What | Command | Path |
|------|---------|------|
| All tests | `bun test` | `packages/cli/` |
| Unit tests | `bun test tests/` | `packages/cli/` |
| Integration | `bun test:integration` | `packages/cli/` |
| LLM evals | `npm run eval` | `packages/cli/` |

---

## Development Workflow

### Editing Source Templates

1. Edit in `packages/cli/templates/` (source of truth)
2. Run `npx safeword upgrade` to sync to `.safeword/`
3. Run evals: `npm run eval`

### Running LLM Evals

```bash
npm run eval           # Run all tests
npm run eval:view      # Open web UI for results
```

**Requires:** `ANTHROPIC_API_KEY` environment variable

## Common Gotchas

1. **packages/cli/templates/ vs .safeword/**: Edit `packages/cli/templates/` first, then run `npx safeword upgrade` to sync.

2. **Eval failures**: Usually means the guide needs clearer instructions, not that the test is wrong.

3. **Planning docs location**: All planning goes in `.safeword/planning/` per the SAFEWORD.md conventions.

4. **Hook paths**: Always use `"$CLAUDE_PROJECT_DIR"/.safeword/hooks/...` format (quoted variable) for Claude Code hooks.

5. **Publishing**: Always run `npm publish` from `packages/cli/` directory, not the monorepo root. Publishing from root publishes a different package.

6. **CLI Reference Drift**: `packages/cli/templates/guides/cli-reference.md` must stay in sync with `README.md` CLI documentation. When updating CLI commands in README, update cli-reference.md too.

7. **README Feature Drift**: When adding commands, skills, or MCP servers to `schema.ts`, update the corresponding section in `README.md`.

---

## CLI Parity (Claude Code / Cursor)

The CLI installs matching skills for both Claude Code and Cursor IDEs.

**Source of truth:** `packages/cli/src/schema.ts`

**Parity tests:** `packages/cli/tests/schema.test.ts` (Claude/Cursor parity section)

| IDE         | Skills Location                | Commands Location       | Format                  |
| ----------- | ------------------------------ | ----------------------- | ----------------------- |
| Claude Code | `.claude/skills/safeword-*/`   | `.claude/commands/*.md` | YAML frontmatter + body |
| Cursor      | `.cursor/rules/safeword-*.mdc` | `.cursor/commands/*.md` | YAML frontmatter + body |

**Skills installed:**

| Skill              | Trigger                                     |
| ------------------ | ------------------------------------------- |
| `brainstorming`    | 'brainstorm', 'design', 'explore options'   |
| `debugging`        | 'debug', 'fix error', 'not working'         |
| `enforcing-tdd`    | 'implement', 'build', 'feature', 'refactor' |
| `quality-reviewer` | 'double check', 'verify versions'           |
| `refactoring`      | 'refactor', 'clean up', 'restructure'       |
| `writing-plans`    | 'write plan', 'execution plan', 'tasks'     |

**Note:** Cursor also gets `safeword-core.mdc` (core instructions, no Claude Code equivalent needed).

**Editing skills:**

1. Edit templates in `packages/cli/templates/skills/` (Claude) and `packages/cli/templates/cursor/rules/` (Cursor)
2. Update `packages/cli/src/schema.ts` if adding/removing skills
3. Run parity tests: `npm test -- --testNamePattern="parity"`
4. Run `npx safeword upgrade` to sync to local project

---

## Project-Specific Content

**Location:** `.safeword-project/` (never touched by CLI reset/upgrade)

| Folder    | Purpose                 |
| --------- | ----------------------- |
| `guides/` | Project-specific guides |
